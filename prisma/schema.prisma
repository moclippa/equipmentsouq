// EquipmentSouq - Haraj-style Equipment Classifieds
// Database Schema for Saudi Arabia & Bahrain
// Simplified from marketplace â†’ classifieds/lead-gen model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  GUEST
  RENTER
  OWNER
  ADMIN
}

enum BusinessType {
  INDIVIDUAL
  RENTAL_COMPANY
  CONTRACTOR
  INDUSTRIAL
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum ListingStatus {
  DRAFT
  ACTIVE
  RENTED     // Temporarily unavailable
  SOLD       // No longer available
  PAUSED     // Owner paused
  ARCHIVED
}

enum ListingType {
  FOR_RENT
  FOR_SALE
  BOTH
}

enum LeadStatus {
  NEW
  VIEWED
  CONTACTED
  CONVERTED
  CLOSED
}

enum Currency {
  SAR
  BHD
}

enum Country {
  SA
  BH
}

enum BookingRequestStatus {
  PENDING       // Renter requested, awaiting owner response
  CONFIRMED     // Owner approved the request
  DECLINED      // Owner rejected the request
  EXPIRED       // Owner didn't respond in time (auto-expired)
  CANCELLED     // Either party cancelled
}

// Trust & Review System
enum ReviewRating {
  EXCELLENT     // 5 stars
  GOOD          // 4 stars
  FAIR          // 3 stars
  POOR          // 2 stars
  VERY_POOR     // 1 star
}

enum ReviewStatus {
  PENDING       // Review request sent, awaiting submission
  SUBMITTED     // Renter submitted review
  RESPONDED     // Owner responded to review
  FLAGGED       // Admin flagged for moderation
}

enum TrustBadge {
  VERIFIED_BUSINESS   // Has verified CR/VAT documents
  VERIFIED_IDENTITY   // Has verified phone + email
  FAST_RESPONDER      // Avg response time < 2 hours
  RELIABLE            // 95%+ response rate
  TOP_RATED           // 4.5+ stars with 10+ reviews
  FEATURED_SELLER     // Paid premium badge (future monetization)
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                  String              @id @default(cuid())
  email               String?             @unique
  emailVerified       DateTime?
  phone               String?             @unique
  phoneVerified       DateTime?
  hashedPassword      String?

  // Profile
  fullName            String
  fullNameAr          String?
  avatarUrl           String?
  role                UserRole            @default(RENTER)
  preferredLanguage   String              @default("en")
  preferredCurrency   Currency            @default(SAR)
  country             Country             @default(SA)

  // Business Information
  businessProfile     BusinessProfile?

  // Status
  isActive            Boolean             @default(true)
  isSuspended         Boolean             @default(false)
  suspendedReason     String?
  suspendedAt         DateTime?

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  lastLoginAt         DateTime?

  // Relations
  accounts            Account[]
  sessions            Session[]

  // As Owner
  equipment           Equipment[]

  // Booking Requests (as renter)
  bookingRequests     BookingRequest[]  @relation("RenterBookingRequests")
  // Booking Requests received (as owner) - accessed via equipment relation

  // Common
  notifications       Notification[]

  // Trust & Reviews
  reviewsReceived     OwnerReview[]       @relation("OwnerReviews")
  reviewsGiven        OwnerReview[]       @relation("ReviewerReviews")
  trustMetrics        OwnerTrustMetrics?

  @@index([phone])
  @@index([email])
  @@index([role])
  @@index([country])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model OTPCode {
  id          String    @id @default(cuid())
  phone       String
  code        String
  type        String
  attempts    Int       @default(0)
  verified    Boolean   @default(false)
  expiresAt   DateTime
  createdAt   DateTime  @default(now())

  @@index([phone, type])
}

// ============================================================================
// BUSINESS PROFILE
// ============================================================================

model BusinessProfile {
  id                    String              @id @default(cuid())
  userId                String              @unique
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business Details
  businessType          BusinessType
  companyNameEn         String
  companyNameAr         String?

  // Registration Numbers
  crNumber              String?
  vatNumber             String?

  // Documents
  crDocumentUrl         String?
  vatDocumentUrl        String?

  // Verification
  crVerificationStatus  VerificationStatus  @default(PENDING)
  vatVerificationStatus VerificationStatus  @default(PENDING)
  verifiedAt            DateTime?
  verifiedBy            String?
  rejectionReason       String?

  // AI-Extracted Data
  aiExtractedData       Json?

  // Address
  addressLine1          String?
  addressLine2          String?
  city                  String
  region                String
  postalCode            String?
  country               Country

  // Contact
  businessPhone         String?
  businessEmail         String?

  // Bank Details (encrypted)
  bankName              String?
  bankAccountName       String?
  bankAccountNumber     String?
  bankIban              String?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([businessType])
  @@index([country])
}

// ============================================================================
// EQUIPMENT & CATEGORIES
// ============================================================================

model Category {
  id            String        @id @default(cuid())
  slug          String        @unique
  nameEn        String
  nameAr        String
  descriptionEn String?
  descriptionAr String?
  iconUrl       String?
  imageUrl      String?
  parentId      String?
  parent        Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[]    @relation("CategoryHierarchy")

  // Category-specific attributes template
  attributeSchema Json?

  // Ordering
  sortOrder     Int           @default(0)
  isActive      Boolean       @default(true)

  equipment     Equipment[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([parentId])
  @@index([slug])
}

model Equipment {
  id                  String            @id @default(cuid())
  ownerId             String
  owner               User              @relation(fields: [ownerId], references: [id])

  // Classification
  categoryId          String
  category            Category          @relation(fields: [categoryId], references: [id])

  // Basic Info
  titleEn             String
  titleAr             String?
  descriptionEn       String            @db.Text
  descriptionAr       String?           @db.Text

  // Equipment Details
  make                String
  model               String
  year                Int?
  condition           String            // EXCELLENT, GOOD, FAIR, POOR
  hoursUsed           Int?

  // AI-Generated Content
  aiGeneratedTitle    Boolean           @default(false)
  aiGeneratedDesc     Boolean           @default(false)
  aiClassified        Boolean           @default(false)

  // Category-specific attributes (optional)
  specifications      Json?

  // Location
  locationCity        String
  locationRegion      String
  locationCountry     Country

  // Listing Type & Pricing (simplified)
  listingType         ListingType       @default(FOR_RENT)
  rentalPrice         Decimal?          @db.Decimal(10, 2)  // e.g., "500 SAR/day"
  rentalPriceUnit     String?           // "day", "week", "month"
  salePrice           Decimal?          @db.Decimal(10, 2)  // e.g., "50000 SAR"
  priceOnRequest      Boolean           @default(false)
  currency            Currency          @default(SAR)

  // Direct Contact (key for classifieds)
  contactPhone        String
  contactWhatsApp     String?

  // Status
  status              ListingStatus     @default(DRAFT)
  statusChangedAt     DateTime?         // Track when status last changed (for auto-archive + "Just Sold" display)

  // Metrics
  viewCount           Int               @default(0)
  leadCount           Int               @default(0)

  // Full-text search vector (managed by PostgreSQL trigger)
  // This column is populated automatically - do not set manually
  // searchVector     Unsupported("tsvector")?

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  publishedAt         DateTime?

  // Relations
  images              EquipmentImage[]
  leads               Lead[]
  availabilityBlocks  AvailabilityBlock[]
  bookingRequests     BookingRequest[]
  qualityScore        ListingQualityScore?

  // === INDEXES ===
  // Primary filters
  @@index([ownerId])
  @@index([categoryId])
  @@index([status])
  @@index([listingType])
  @@index([locationCity])
  @@index([locationCountry])
  @@index([createdAt])

  // Price range queries
  @@index([rentalPrice])
  @@index([salePrice])

  // Compound indexes for common query patterns
  @@index([status, statusChangedAt])           // Recent transactions query
  @@index([status, locationCountry, listingType]) // Search filters combo
  @@index([status, categoryId])                // Category browsing
  @@index([status, locationCity])              // Local search
  @@index([ownerId, status, createdAt])        // Owner's listing management
}

model EquipmentImage {
  id            String      @id @default(cuid())
  equipmentId   String
  equipment     Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  url           String
  thumbnailUrl  String?
  altTextEn     String?
  altTextAr     String?
  sortOrder     Int         @default(0)
  isPrimary     Boolean     @default(false)

  // AI Analysis
  aiAnalyzed    Boolean     @default(false)
  aiTags        Json?

  createdAt     DateTime    @default(now())

  @@index([equipmentId])
}

// ============================================================================
// LEADS (replaces Booking for classifieds)
// ============================================================================

model Lead {
  id              String        @id @default(cuid())
  equipmentId     String
  equipment       Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  // Requester info
  name            String
  phone           String
  email           String?
  message         String?       @db.Text

  // What they want
  interestedIn    String        // "rent", "buy", "both"

  // Status tracking
  status          LeadStatus    @default(NEW)
  ownerViewedAt   DateTime?
  ownerContactedAt DateTime?
  ownerRespondedAt DateTime?    // When owner first responded (for metrics)

  createdAt       DateTime      @default(now())

  // Trust & Reviews
  review          OwnerReview?
  reviewRequest   ReviewRequest?

  // === INDEXES ===
  @@index([equipmentId])
  @@index([status])
  @@index([createdAt])
  @@index([equipmentId, status, createdAt])  // Owner's lead management
  @@index([status, createdAt])               // Dashboard stats
}

// ============================================================================
// AVAILABILITY CALENDAR
// ============================================================================

model AvailabilityBlock {
  id            String      @id @default(cuid())
  equipmentId   String
  equipment     Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  // Date range
  startDate     DateTime    @db.Date
  endDate       DateTime    @db.Date

  // Block type
  isAvailable   Boolean     @default(false)  // true = available, false = unavailable/blocked
  reason        String?     // Optional: "Maintenance", "Rented externally", "Holiday", etc.

  // Metadata
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([equipmentId])
  @@index([startDate, endDate])
  @@index([equipmentId, startDate, endDate])
}

// ============================================================================
// BOOKING REQUESTS (Request-Based Soft Hold System)
// ============================================================================

model BookingRequest {
  id              String                @id @default(cuid())

  // Equipment being requested
  equipmentId     String
  equipment       Equipment             @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  // Renter making the request
  renterId        String
  renter          User                  @relation("RenterBookingRequests", fields: [renterId], references: [id], onDelete: Cascade)

  // Requested dates
  startDate       DateTime              @db.Date
  endDate         DateTime              @db.Date

  // Request status
  status          BookingRequestStatus  @default(PENDING)

  // Communication
  renterMessage   String?               @db.Text  // Message from renter to owner
  ownerResponse   String?               @db.Text  // Owner's response/notes

  // Contact info (captured at request time)
  renterName      String
  renterPhone     String
  renterEmail     String?

  // Timing
  expiresAt       DateTime              // When pending request auto-expires (e.g., 48h from creation)
  respondedAt     DateTime?             // When owner responded

  // Timestamps
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // === INDEXES ===
  @@index([equipmentId])
  @@index([renterId])
  @@index([status])
  @@index([expiresAt])
  @@index([equipmentId, startDate, endDate])        // Date range queries
  @@index([equipmentId, status])                    // Owner dashboard filter
  @@index([equipmentId, status, startDate, endDate]) // Conflict detection
  @@index([renterId, status, createdAt])            // Renter's request history
}

// ============================================================================
// TRUST & REVIEW SYSTEM
// ============================================================================

// Owner reviews from renters (request-based, 7 days after lead)
model OwnerReview {
  id              String        @id @default(cuid())

  // Relations
  leadId          String        @unique // One review per lead
  lead            Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  ownerId         String
  owner           User          @relation("OwnerReviews", fields: [ownerId], references: [id], onDelete: Cascade)
  reviewerId      String
  reviewer        User          @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)

  // Review content
  rating          ReviewRating
  title           String?
  comment         String?       @db.Text

  // Owner response
  ownerResponse   String?       @db.Text
  respondedAt     DateTime?

  // Metadata
  status          ReviewStatus  @default(SUBMITTED)
  isVerified      Boolean       @default(false) // Only true if lead converted
  flaggedReason   String?

  // Response metrics captured at review time (immutable)
  responseTimeHours Int?        // Hours from lead creation to ownerRespondedAt
  didOwnerRespond   Boolean     @default(false)

  // Timestamps
  requestedAt     DateTime      // When review was requested (lead + 7 days)
  submittedAt     DateTime?     // When reviewer submitted
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([ownerId, status, createdAt])
  @@index([reviewerId, createdAt])
  @@index([status, isVerified])
}

// Pre-computed trust metrics for owners (cached in DB + Redis)
model OwnerTrustMetrics {
  id                    String      @id @default(cuid())
  ownerId               String      @unique
  owner                 User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Response metrics (computed from Leads)
  totalLeads            Int         @default(0)
  respondedLeads        Int         @default(0)   // Status changed from NEW
  avgResponseTimeHours  Decimal?    @db.Decimal(10, 2) // Average ownerRespondedAt - createdAt
  responseRate          Decimal?    @db.Decimal(5, 2)  // respondedLeads / totalLeads * 100

  // Review metrics
  totalReviews          Int         @default(0)
  averageRating         Decimal?    @db.Decimal(3, 2)  // 1.00 - 5.00
  excellentCount        Int         @default(0)
  goodCount             Int         @default(0)
  fairCount             Int         @default(0)
  poorCount             Int         @default(0)
  veryPoorCount         Int         @default(0)

  // Listing quality (computed from Equipment)
  totalListings         Int         @default(0)
  activeListings        Int         @default(0)
  avgListingQuality     Decimal?    @db.Decimal(5, 2)  // 0-100 score

  // Composite trust score (0-100)
  trustScore            Decimal     @db.Decimal(5, 2) @default(0)

  // Earned badges
  badges                TrustBadge[]

  // Last recalculation
  lastCalculatedAt      DateTime    @default(now())

  @@index([trustScore])
  @@index([averageRating])
  @@index([responseRate])
}

// Quality score for each listing (computed on create/update)
model ListingQualityScore {
  id                    String      @id @default(cuid())
  equipmentId           String      @unique
  equipment             Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  // Component scores (0-100)
  photoScore            Decimal     @db.Decimal(5, 2) @default(0)   // Based on image count
  descriptionScore      Decimal     @db.Decimal(5, 2) @default(0)   // Based on length/completeness
  specificationScore    Decimal     @db.Decimal(5, 2) @default(0)   // Based on specs filled

  // Composite score
  overallScore          Decimal     @db.Decimal(5, 2) @default(0)   // Weighted average

  // Metadata
  calculatedAt          DateTime    @default(now())

  @@index([overallScore])
}

// Review request tracking (ensures 7-day delay + one request per lead)
model ReviewRequest {
  id                String    @id @default(cuid())
  leadId            String    @unique
  lead              Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Sent to
  reviewerEmail     String?
  reviewerPhone     String?

  // Status
  sentAt            DateTime  @default(now())
  reminderSentAt    DateTime? // Optional reminder after 14 days
  completedAt       DateTime? // When review submitted
  expiredAt         DateTime? // Review requests expire after 30 days

  @@index([sentAt])
  @@index([completedAt])
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  type          String
  titleEn       String
  titleAr       String?
  bodyEn        String
  bodyAr        String?

  // Action
  actionUrl     String?
  actionData    Json?

  // Status
  isRead        Boolean     @default(false)
  readAt        DateTime?

  // Delivery
  emailSent     Boolean     @default(false)
  smsSent       Boolean     @default(false)
  pushSent      Boolean     @default(false)

  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================================================
// ADMIN & CONFIGURATION
// ============================================================================

model AdminConfig {
  id            String      @id @default(cuid())
  key           String      @unique
  value         Json
  description   String?
  updatedAt     DateTime    @updatedAt
  updatedBy     String?
}

model AdminAuditLog {
  id            String      @id @default(cuid())
  adminId       String
  action        String
  targetType    String
  targetId      String
  details       Json?
  ipAddress     String?
  createdAt     DateTime    @default(now())

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ============================================================================
// AI & ANALYTICS
// ============================================================================

model AIUsageLog {
  id            String      @id @default(cuid())
  provider      String
  service       String
  inputTokens   Int
  outputTokens  Int
  cost          Decimal     @db.Decimal(10, 6)
  latencyMs     Int
  success       Boolean
  errorMessage  String?
  metadata      Json?
  createdAt     DateTime    @default(now())

  @@index([provider])
  @@index([service])
  @@index([createdAt])
}

model AnalyticsEvent {
  id            String      @id @default(cuid())
  eventType     String
  userId        String?
  sessionId     String?
  data          Json
  country       Country?
  createdAt     DateTime    @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
}
